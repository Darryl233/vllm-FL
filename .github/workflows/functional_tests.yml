name: Functional Tests CUDA

on:
  push:
    branches: main
  pull_request:
    branches: main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  functional_test:
    defaults:
      run:
        shell: bash
    runs-on: [ self-hosted, Linux, X64, gpu-8, nviida ]
    container:
      image: harbor.baai.ac.cn/flagscale/cuda12.8.1-torch2.8.0-python3.10-vllm0.11.0_fl.0.1:20260205
      options: --gpus all --shm-size=500g --hostname vllm_fl_cicd --user root --ulimit nofile=65535:65535
    strategy:
      fail-fast: false
      matrix:
        subset:
          - basic_correctness
          # - distributed
          # - entrypoints_llm
          # - entrypoints_openai
          # - entrypoints_pooling
          # - entrypoints_offline_mode
          # - evals
          # - fastsafetensors_loader
          # - kv_transfer
          # - lora
          # - mistral_tool_use
          # - models
          # - quantization
          # - samplers
          # - speculative_decoding
          # - tensorizer_loader
          # - tool_use
          # - weight_loading
          # - v1_e2e
          # - v1_entrypoints
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install auxiliary tools
        timeout-minutes: 5
        run: |
          set -euo pipefail

          YQ_VERSION="v4.45.1"
          JQ_VERSION="1.7.1"
          BIN_DIR="/usr/local/bin"

          [ -w "$BIN_DIR" ] || { echo "Error: $BIN_DIR is not writable!"; exit 1; }

          # Install mikefarah/yq (v4) for YAML parsing
          echo "Installing yq $YQ_VERSION..."
          curl -sSL --retry 3 -k "https://github.com/mikefarah/yq/releases/download/$YQ_VERSION/yq_linux_amd64" -o "$BIN_DIR/yq"
          chmod +x "$BIN_DIR/yq"
          yq --version

          echo "Installing jq $JQ_VERSION..."
          curl -sSL --retry 3 -k "https://github.com/jqlang/jq/releases/download/jq-$JQ_VERSION/jq-linux-amd64" -o "$BIN_DIR/jq"
          chmod +x "$BIN_DIR/jq"
          jq --version

      - name: Install dependencies and build vLLM
        timeout-minutes: 90
        run: |
          # Activate Conda Environment
          source /opt/miniconda3/etc/profile.d/conda.sh
          conda activate flagscale-inference

          # Install Requirements
          pip install -r requirements/cuda.txt
          pip install -r requirements/common.txt
          pip install transformers==4.55.2 huggingface-hub==0.34.3
          # Install vLLM in Editable Mode
          pip install -e . -vvv

          # Verify vLLM Installation
          python3 -c "import vllm; print(f'vLLM version: {vllm.__version__}')"
          python -c 'import vllm._C; print("vllm._C imported successfully")'
        env:
          CMAKE_BUILD_PARALLEL_LEVEL: 4

      - name: Load config for ${{ matrix.subset }}
        id: config
        run: |
          set -euo pipefail

          CONFIG_FILE=".github/configs/functional.yml"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå Error: Platform configuration file not found: $CONFIG_FILE"
            echo "Available configs:"
            ls -la .github/configs/
            exit 1
          fi

           # Source the platform config loading script
          source .github/scripts/load_config.sh

          # Load configuration and group tests by task
          load_config ${{ matrix.subset }} "$CONFIG_FILE" functional-conf

      - name: Run test for ${{ matrix.subset }}
        run: |
          ignore="${{ steps.config.outputs.ignore }}"
          deselect="${{ steps.config.outputs.deselect }}"
          test_files="${{ steps.config.outputs.test_files }}"

          echo "ignore: $ignore"
          echo "deselect: $deselect"
          echo "test_files: $test_files"

          source /opt/miniconda3/etc/profile.d/conda.sh
          conda activate flagscale-inference

          python -m pytest -q -x -p no:warnings $ignore $deselect $test_files
